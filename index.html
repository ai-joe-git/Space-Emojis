<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dungeon Crawler RPG</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #fff; font-family: Arial, sans-serif; }
        #gameArea { white-space: pre; font-size: 20px; line-height: 20px; }
        #ui { position: absolute; top: 10px; left: 10px; }
        #message { position: absolute; bottom: 10px; left: 10px; }
    </style>
</head>
<body>
    <div id="ui"></div>
    <div id="gameArea"></div>
    <div id="message"></div>

    <script>
        const gameArea = document.getElementById('gameArea');
        const ui = document.getElementById('ui');
        const messageElement = document.getElementById('message');
        const GRID_SIZE = 20;
        const TILE_SIZE = 1; // Not used but kept for reference
        let player, enemies, items, level, currentLevel;

        const classes = {
            Warrior: {
                icon: '🛡️',
                baseStats: { hp: 120, maxHp: 120, attack: 15, defense: 10, speed: 1 },
                abilities: [
                    { name: 'Slash', icon: '🗡️', damage: 20 },
                    { name: 'Shield Bash', icon: '🛡️', damage: 15, defense: 5 },
                ]
            },
            Mage: {
                icon: '🧙',
                baseStats: { hp: 80, maxHp: 80, attack: 20, defense: 5, speed: 1 },
                abilities: [
                    { name: 'Fireball', icon: '🔥', damage: 25 },
                    { name: 'Frost Nova', icon: '❄️', damage: 15, slow: 2 },
                ]
            },
            Rogue: {
                icon: '🥷',
                baseStats: { hp: 100, maxHp: 100, attack: 12, defense: 7, speed: 2 },
                abilities: [
                    { name: 'Backstab', icon: '🗡️', damage: 30 },
                    { name: 'Smoke Bomb', icon: '💨', defense: 10 },
                ]
            }
        };

        const classAbilities = {
            Warrior: [
                { name: 'Whirlwind', icon: '🌪️', damage: 30, aoe: true },
                { name: 'Fortify', icon: '🏰', defense: 15 },
            ],
            Mage: [
                { name: 'Lightning Bolt', icon: '⚡', damage: 35 },
                { name: 'Arcane Barrier', icon: '🔮', defense: 20 },
            ],
            Rogue: [
                { name: 'Poison Dagger', icon: '🗡️', damage: 20, dot: 10 },
                { name: 'Shadow Step', icon: '👥', speed: 3 },
            ]
        };

        function initializeGame() {
            currentLevel = 1;
            
            let classChoice = prompt(`Choose your class:\n1. Warrior ${classes.Warrior.icon}\n2. Mage ${classes.Mage.icon}\n3. Rogue ${classes.Rogue.icon}`);
            let selectedClass;
            switch(classChoice) {
                case '1': selectedClass = 'Warrior'; break;
                case '2': selectedClass = 'Mage'; break;
                case '3': selectedClass = 'Rogue'; break;
                default: selectedClass = 'Warrior';
            }
            
            player = {
                ...classes[selectedClass].baseStats,
                x: 0, y: 0,
                level: 1,
                xp: 0,
                class: selectedClass,
                appearance: classes[selectedClass].icon,
                abilities: [...classes[selectedClass].abilities]
            };
            
            initializeLevel();
        }

        function initializeLevel() {
            // Clear previous game state
            gameArea.textContent = '';

            // Generate level
            level = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill('🟫'));
            for (let i = 0; i < GRID_SIZE; i++) {
                level[0][i] = level[GRID_SIZE-1][i] = level[i][0] = level[i][GRID_SIZE-1] = '🧱';
            }

            // Place walls
            for (let i = 0; i < 50; i++) {
                let x = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                let y = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                level[y][x] = '🧱';
            }

            // Place player
            player.x = 1;
            player.y = 1;
            level[player.y][player.x] = player.appearance;

            // Place enemies
            enemies = [];
            for (let i = 0; i < 5; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                    y = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                } while (level[y][x] !== '🟫' || (x === player.x && y === player.y));
                level[y][x] = '👾';
                enemies.push({ 
                    x, y, 
                    hp: 30 + currentLevel * 5, 
                    attack: 5 + currentLevel,
                    defense: 2 + Math.floor(currentLevel / 2)
                });
            }

            // Place items
            items = [];
            for (let i = 0; i < 3; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                    y = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                } while (level[y][x] !== '🟫' || (x === player.x && y === player.y));
                level[y][x] = '🧪';
                items.push({ x, y });
            }

            renderLevel();
            updateUI();
        }

        function renderLevel() {
            gameArea.textContent = level.map(row => row.join('')).join('\n');
        }

        function updateUI() {
            ui.innerHTML = `
                Level: ${currentLevel} | 
                Class: ${player.class} ${classes[player.class].icon} | 
                HP: ${player.hp}/${player.maxHp} | 
                XP: ${player.xp}/${player.level * 20} | 
                Attack: ${player.attack} | 
                Defense: ${player.defense} | 
                Speed: ${player.speed}
            `;
        }

        function showMessage(msg) {
            messageElement.textContent = msg;
            setTimeout(() => messageElement.textContent = '', 3000);
        }

        function movePlayer(dx, dy) {
            let newX = player.x + dx;
            let newY = player.y + dy;

            if (level[newY][newX] === '🟫') {
                level[player.y][player.x] = '🟫';
                player.x = newX;
                player.y = newY;
                level[player.y][player.x] = player.appearance;
            }

            // Check for item pickup
            items = items.filter(item => {
                if (item.x === player.x && item.y === player.y) {
                    level[player.y][player.x] = player.appearance;
                    player.hp = Math.min(player.maxHp, player.hp + 20);
                    showMessage('Health potion picked up! +20 HP');
                    updateUI();
                    return false;
                }
                return true;
            });

            // Check for enemy encounter
            enemies.forEach(enemy => {
                if (Math.abs(enemy.x - player.x) <= 1 && Math.abs(enemy.y - player.y) <= 1) {
                    combat(enemy);
                }
            });

            // Check if level is cleared
            if (enemies.length === 0) {
                currentLevel++;
                showMessage(`Level ${currentLevel} completed! Starting next level...`);
                setTimeout(initializeLevel, 2000);
            }

            renderLevel();
        }

        function combat(enemy) {
            let abilityChoice = prompt(`Choose an action:\n${player.abilities.map((a, i) => `${i + 1}. ${a.name} ${a.icon}`).join('\n')}\n${player.abilities.length + 1}. Regular attack`);
            let chosenAbility = player.abilities[parseInt(abilityChoice) - 1];
            
            let playerDamage = player.attack - enemy.defense;
            if (chosenAbility) {
                playerDamage = Math.max(0, (chosenAbility.damage || playerDamage) - enemy.defense);
                if (chosenAbility.defense) {
                    player.defense += chosenAbility.defense;
                    setTimeout(() => player.defense -= chosenAbility.defense, 1000);
                }
                if (chosenAbility.speed) {
                    player.speed += chosenAbility.speed;
                    setTimeout(() => player.speed -= chosenAbility.speed, 1000);
                }
                showMessage(`You used ${chosenAbility.name} for ${playerDamage} damage!`);
            } else {
                showMessage(`You attack for ${playerDamage} damage!`);
            }
            
            enemy.hp -= playerDamage;

            if (enemy.hp <= 0) {
                showMessage('Enemy defeated!');
                level[enemy.y][enemy.x] = '🟫';
                enemies = enemies.filter(e => e !== enemy);
                player.xp += 10;
                if (player.xp >= player.level * 20) {
                    levelUp();
                }
            } else {
                let enemyDamage = Math.max(1, enemy.attack - player.defense);
                player.hp -= enemyDamage;
                showMessage(`Enemy attacks for ${enemyDamage} damage!`);

                if (player.hp <= 0) {
                    alert('Game Over! You died.');
                    initializeGame();
                }
            }

            updateUI();
            renderLevel();
        }

        function levelUp() {
            player.level++;
            player.maxHp += 20;
            player.hp = player.maxHp;
            player.attack += 2;
            player.defense += 1;
            player.xp = 0;

            showMessage(`🎉 Level up! You are now level ${player.level}.`);

            if (player.level % 3 === 0 && player.abilities.length < 6) {
                let availableAbilities = classAbilities[player.class].filter(a => !player.abilities.some(pa => pa.name === a.name));
                if (availableAbilities.length > 0) {
                    let choice = prompt(`Choose a new ${player.class} ability:\n${availableAbilities.map((a, i) => `${i + 1}. ${a.name} ${a.icon}`).join('\n')}`);
                    let chosenAbility = availableAbilities[parseInt(choice) - 1];
                    if (chosenAbility) {
                        player.abilities.push(chosenAbility);
                        showMessage(`You learned ${chosenAbility.name} ${chosenAbility.icon}!`);
                    }
                }
            }

            updateUI();
        }

        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowUp': movePlayer(0, -1); break;
                case 'ArrowDown': movePlayer(0, 1); break;
                case 'ArrowLeft': movePlayer(-1, 0); break;
                case 'ArrowRight': movePlayer(1, 0); break;
            }
        });

        initializeGame();
    </script>
</body>
</html>
