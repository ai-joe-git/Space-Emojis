<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Dungeon Crawler RPG</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #fff; font-family: Arial, sans-serif; }
        #gameArea { 
            position: absolute; 
            top: 50px; 
            left: 10px; 
            white-space: pre; 
            font-size: 20px; 
            line-height: 20px;
            border: 1px solid #fff;
        }
        #ui { 
            position: absolute; 
            top: 10px; 
            left: 10px; 
            background: rgba(0,0,0,0.7); 
            padding: 5px;
        }
        #message { position: absolute; bottom: 10px; left: 10px; }
        #inventory { position: absolute; top: 10px; right: 10px; }
        #abilities { position: absolute; bottom: 40px; left: 10px; }
        .ability-button { margin: 5px; padding: 5px 10px; }
    </style>
</head>
<body>
    <div id="ui"></div>
    <div id="gameArea"></div>
    <div id="message"></div>
    <div id="inventory"></div>
    <div id="abilities"></div>

    <script>
        const gameArea = document.getElementById('gameArea');
        const ui = document.getElementById('ui');
        const messageElement = document.getElementById('message');
        const inventoryElement = document.getElementById('inventory');
        const abilitiesElement = document.getElementById('abilities');
        const GRID_SIZE = 20;
        const TILE_SIZE = 1;
        let player, enemies, items, level, currentLevel, stairs;

        const classes = {
            Warrior: {
                icon: '🛡️',
                baseStats: { hp: 120, maxHp: 120, attack: 15, defense: 10, speed: 1, mana: 50, maxMana: 50 },
                abilities: [
                    { name: 'Slash', icon: '🗡️', damage: 20, manaCost: 5 },
                    { name: 'Shield Bash', icon: '🛡️', damage: 15, defense: 5, manaCost: 10 },
                ]
            },
            Mage: {
                icon: '🧙',
                baseStats: { hp: 80, maxHp: 80, attack: 20, defense: 5, speed: 1, mana: 100, maxMana: 100 },
                abilities: [
                    { name: 'Fireball', icon: '🔥', damage: 25, manaCost: 15 },
                    { name: 'Frost Nova', icon: '❄️', damage: 15, slow: 2, manaCost: 20 },
                ]
            },
            Rogue: {
                icon: '🥷',
                baseStats: { hp: 100, maxHp: 100, attack: 12, defense: 7, speed: 2, mana: 75, maxMana: 75 },
                abilities: [
                    { name: 'Backstab', icon: '🗡️', damage: 30, manaCost: 10 },
                    { name: 'Smoke Bomb', icon: '💨', defense: 10, manaCost: 15 },
                ]
            }
        };

        const classAbilities = {
            Warrior: [
                { name: 'Whirlwind', icon: '🌪️', damage: 30, aoe: true, manaCost: 25 },
                { name: 'Fortify', icon: '🏰', defense: 15, manaCost: 20 },
            ],
            Mage: [
                { name: 'Lightning Bolt', icon: '⚡', damage: 35, manaCost: 30 },
                { name: 'Arcane Barrier', icon: '🔮', defense: 20, manaCost: 25 },
            ],
            Rogue: [
                { name: 'Poison Dagger', icon: '🗡️', damage: 20, dot: 10, manaCost: 20 },
                { name: 'Shadow Step', icon: '👥', speed: 3, manaCost: 25 },
            ]
        };

        const itemTypes = [
            { name: 'Health Potion', icon: '🧪', effect: { hp: 30 } },
            { name: 'Mana Potion', icon: '🧪', effect: { mana: 30 } },
            { name: 'Strength Potion', icon: '🧪', effect: { attack: 5 }, duration: 5 },
            { name: 'Defense Potion', icon: '🧪', effect: { defense: 5 }, duration: 5 },
            { name: 'Speed Potion', icon: '🧪', effect: { speed: 1 }, duration: 5 },
        ];

        function initializeGame() {
            currentLevel = 1;
            
            let classChoice = prompt(`Choose your class:\n1. Warrior ${classes.Warrior.icon}\n2. Mage ${classes.Mage.icon}\n3. Rogue ${classes.Rogue.icon}`);
            let selectedClass;
            switch(classChoice) {
                case '1': selectedClass = 'Warrior'; break;
                case '2': selectedClass = 'Mage'; break;
                case '3': selectedClass = 'Rogue'; break;
                default: selectedClass = 'Warrior';
            }
            
            player = {
                ...classes[selectedClass].baseStats,
                x: 0, y: 0,
                level: 1,
                xp: 0,
                class: selectedClass,
                appearance: classes[selectedClass].icon,
                abilities: [...classes[selectedClass].abilities],
                inventory: [],
                gold: 0,
                buffs: []
            };
            
            createAbilityButtons();
            initializeLevel();
        }

        function initializeLevel() {
            gameArea.textContent = '';

            level = Array(GRID_SIZE).fill().map(() => Array(GRID_SIZE).fill('🟫'));
            for (let i = 0; i < GRID_SIZE; i++) {
                level[0][i] = level[GRID_SIZE-1][i] = level[i][0] = level[i][GRID_SIZE-1] = '🧱';
            }

            for (let i = 0; i < 50; i++) {
                let x = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                let y = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                level[y][x] = '🧱';
            }

            player.x = 1;
            player.y = 1;
            level[player.y][player.x] = player.appearance;

            enemies = [];
            for (let i = 0; i < 5 + currentLevel; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                    y = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                } while (level[y][x] !== '🟫' || (x === player.x && y === player.y));
                level[y][x] = '👾';
                enemies.push({ 
                    x, y, 
                    hp: 30 + currentLevel * 5, 
                    attack: 5 + currentLevel,
                    defense: 2 + Math.floor(currentLevel / 2)
                });
            }

            items = [];
            for (let i = 0; i < 3; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                    y = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                } while (level[y][x] !== '🟫' || (x === player.x && y === player.y));
                let item = {...itemTypes[Math.floor(Math.random() * itemTypes.length)]};
                level[y][x] = item.icon;
                items.push({ ...item, x, y });
            }

            // Add gold
            for (let i = 0; i < 2; i++) {
                let x, y;
                do {
                    x = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                    y = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                } while (level[y][x] !== '🟫' || (x === player.x && y === player.y));
                level[y][x] = '💰';
                items.push({ name: 'Gold', icon: '💰', x, y, amount: Math.floor(Math.random() * 20) + 10 });
            }

            // Place stairs
            stairs = { x: 0, y: 0 };
            do {
                stairs.x = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
                stairs.y = Math.floor(Math.random() * (GRID_SIZE - 2)) + 1;
            } while (level[stairs.y][stairs.x] !== '🟫');
            level[stairs.y][stairs.x] = '🚪';

            renderLevel();
            updateUI();
        }

        function renderLevel() {
            gameArea.textContent = level.map(row => row.join('')).join('\n');
        }

        function updateUI() {
            ui.innerHTML = `
                Level: ${currentLevel} | 
                Class: ${player.class} ${classes[player.class].icon} | 
                HP: ${player.hp}/${player.maxHp} | 
                Mana: ${player.mana}/${player.maxMana} | 
                XP: ${player.xp}/${player.level * 20} | 
                Attack: ${player.attack} | 
                Defense: ${player.defense} | 
                Speed: ${player.speed} | 
                Gold: ${player.gold}
            `;

            inventoryElement.innerHTML = 'Inventory: ' + player.inventory.map(item => item.icon).join(' ');

            // Display active buffs
            let buffDisplay = player.buffs.map(buff => `${buff.name}: ${buff.duration} turns`).join(', ');
            if (buffDisplay) {
                ui.innerHTML += '<br>Active Buffs: ' + buffDisplay;
            }
        }

        function showMessage(msg) {
            messageElement.textContent = msg;
            setTimeout(() => messageElement.textContent = '', 3000);
        }

        function movePlayer(dx, dy) {
            let newX = player.x + dx;
            let newY = player.y + dy;

            if (newX === stairs.x && newY === stairs.y) {
                currentLevel++;
                showMessage(`Descending to level ${currentLevel}...`);
                setTimeout(initializeLevel, 1000);
                return;
            }

            if (level[newY][newX] === '🟫' || level[newY][newX] === '💰' || level[newY][newX] === '🧪') {
                level[player.y][player.x] = '🟫';
                player.x = newX;
                player.y = newY;

                // Item pickup
                let item = items.find(item => item.x === player.x && item.y === player.y);
                if (item) {
                    if (item.name === 'Gold') {
                        player.gold += item.amount;
                        showMessage(`Picked up ${item.amount} gold!`);
                    } else {
                        player.inventory.push(item);
                        showMessage(`Picked up ${item.name}!`);
                    }
                    items = items.filter(i => i !== item);
                }

                level[player.y][player.x] = player.appearance;
            }

            // Enemy movement and combat
            enemies.forEach(enemy => {
                if (Math.abs(enemy.x - player.x) <= 1 && Math.abs(enemy.y - player.y) <= 1) {
                    combat(enemy);
                } else {
                    moveEnemy(enemy);
                }
            });

            // Update buffs
            player.buffs = player.buffs.filter(buff => {
                buff.duration--;
                if (buff.duration <= 0) {
                    // Remove buff effect
                    Object.keys(buff.effect).forEach(stat => {
                        player[stat] -= buff.effect[stat];
                    });
                    return false;
                }
                return true;
            });

            // Regenerate mana
            player.mana = Math.min(player.maxMana, player.mana + 1);

            // Check if level is cleared
            if (enemies.length === 0) {
                showMessage(`All enemies defeated! Find the stairs (🚪) to proceed to the next level.`);
            }

            renderLevel();
            updateUI();
        }

        function moveEnemy(enemy) {
            let dx = Math.sign(player.x - enemy.x);
            let dy = Math.sign(player.y - enemy.y);
            let newX = enemy.x + dx;
            let newY = enemy.y + dy;

            if (level[newY][newX] === '🟫') {
                level[enemy.y][enemy.x] = '🟫';
                enemy.x = newX;
                enemy.y = newY;
                level[enemy.y][enemy.x] = '👾';
            }
        }

        function combat(enemy) {
            let playerDamage = Math.max(0, player.attack - enemy.defense);
            enemy.hp -= playerDamage;
            showMessage(`You attack for ${playerDamage} damage!`);

            if (enemy.hp <= 0) {
                showMessage('Enemy defeated!');
                level[enemy.y][enemy.x] = '🟫';
                enemies = enemies.filter(e => e !== enemy);
                player.xp += 10;
                if (player.xp >= player.level * 20) {
                    levelUp();
                }
            } else {
                let enemyDamage = Math.max(1, enemy.attack - player.defense);
                player.hp -= enemyDamage;
                showMessage(`Enemy attacks for ${enemyDamage} damage!`);

                if (player.hp <= 0) {
                    alert('Game Over! You died.');
                    initializeGame();
                }
            }

            updateUI();
            renderLevel();
        }

function levelUp() {
    player.level++;
    player.maxHp += 20;
    player.hp = player.maxHp;
    player.maxMana += 10;
    player.mana = player.maxMana;
    player.attack += 2;
    player.defense += 1;
    player.xp = 0;

    showMessage(`🎉 Level up! You are now level ${player.level}.`);

    if (player.level % 3 === 0 && player.abilities.length < 6) {
        let availableAbilities = classAbilities[player.class].filter(a => !player.abilities.some(pa => pa.name === a.name));
        if (availableAbilities.length > 0) {
            let newAbility = availableAbilities[Math.floor(Math.random() * availableAbilities.length)];
            player.abilities.push(newAbility);
            showMessage(`You learned a new ability: ${newAbility.name}!`);
            createAbilityButtons();
        }
    }
}

        function useItem(item) {
            if (item.effect.hp) {
                player.hp = Math.min(player.maxHp, player.hp + item.effect.hp);
                showMessage(`You used ${item.name} and restored ${item.effect.hp} HP.`);
            } else if (item.effect.mana) {
                player.mana = Math.min(player.maxMana, player.mana + item.effect.mana);
                showMessage(`You used ${item.name} and restored ${item.effect.mana} Mana.`);
            } else {
                // Apply buff
                player.buffs.push({
                    name: item.name,
                    effect: item.effect,
                    duration: item.duration
                });
                Object.keys(item.effect).forEach(stat => {
                    player[stat] += item.effect[stat];
                });
                showMessage(`You used ${item.name} and gained a temporary buff!`);
            }
            player.inventory = player.inventory.filter(i => i !== item);
            updateUI();
        }

        function createAbilityButtons() {
            abilitiesElement.innerHTML = '';
            player.abilities.forEach(ability => {
                let button = document.createElement('button');
                button.textContent = `${ability.icon} ${ability.name}`;
                button.classList.add('ability-button');
                button.onclick = () => useAbility(ability);
                abilitiesElement.appendChild(button);
            });
        }

        function useAbility(ability) {
            if (player.mana < ability.manaCost) {
                showMessage("Not enough mana!");
                return;
            }

            player.mana -= ability.manaCost;

            if (ability.damage) {
                enemies.forEach(enemy => {
                    if (Math.abs(enemy.x - player.x) <= 1 && Math.abs(enemy.y - player.y) <= 1) {
                        enemy.hp -= ability.damage;
                        showMessage(`${ability.name} deals ${ability.damage} damage to enemy!`);
                        if (enemy.hp <= 0) {
                            showMessage('Enemy defeated!');
                            level[enemy.y][enemy.x] = '🟫';
                            enemies = enemies.filter(e => e !== enemy);
                            player.xp += 10;
                            if (player.xp >= player.level * 20) {
                                levelUp();
                            }
                        }
                    }
                });
            }

            if (ability.defense) {
                player.defense += ability.defense;
                setTimeout(() => player.defense -= ability.defense, 3000);
                showMessage(`${ability.name} increases your defense temporarily!`);
            }

            if (ability.speed) {
                player.speed += ability.speed;
                setTimeout(() => player.speed -= ability.speed, 3000);
                showMessage(`${ability.name} increases your speed temporarily!`);
            }

            updateUI();
            renderLevel();
        }

        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case 'ArrowUp': movePlayer(0, -1); break;
                case 'ArrowDown': movePlayer(0, 1); break;
                case 'ArrowLeft': movePlayer(-1, 0); break;
                case 'ArrowRight': movePlayer(1, 0); break;
                case ' ': 
                    if (player.inventory.length > 0) {
                        useItem(player.inventory[0]);
                    }
                    break;
            }
        });

        initializeGame();
    </script>
</body>
</html>
